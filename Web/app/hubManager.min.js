app.factory("hubManager",["$rootScope","notifications",function(n,t){function u(t){n.$$phase?t&&t():n.$apply(t)}function o(){r.state!==$.signalR.connectionState.connected&&r.start().fail(function(){t.error("Will attempt to reconnect in a minute.","Failed to connect to PoMo!");setTimeout(o,6e4)})}function s(n){function v(n){for(var i=0,u=t.length-1,r,f;u>=i;){r=i+Math.floor((u-i)/2);f=t[r][l];switch(f.localeCompare(n)){case 0:return r;case-1:i=r+1;break;case 1:u=r-1}}return~i}function y(n){var t={};return _.forEach(c,function(i,r){var u=n[r];r==a&&(s+=u);t[i]=u}),o[t[l]]=t}f=i;var h=!0,t,l,s=0,c,a=-1,o=null;i={portfolioId:n,subscribe:function(){(h=!0,r.state===$.signalR.connectionState.connected)&&e.invoke.apply(e,n?["SubscribeToPortfolio",n]:["SubscribeToFirmSummary"]).done(function(n){c=_.map(n.cols,function(n,t){return n.name=="Pnl"&&(a=t),n.name});s=0;l=c[n.key[0]];o={};t=_.map(n.rows,y);u(function(){h=!1})})},unsubscribe:function(){(t=null,o=null,r.state===$.signalR.connectionState.connected)&&e.invoke.apply(e,n?["UnsubscribeFromPortfolio",n]:["UnsubscribeFromFirmSummary"])},onChanges:function(n){o&&t&&_.forEach(n,function(n){var i,u,r;switch(n.type){case"added":u=v(n.rowKey);u<0&&t.splice(~u,0,y(n.data));break;case"columnsChanged":if(!n.rowKey in o)return;i=o[n.rowKey];_.forEach(n.changes,function(n){var r,u,t;n.columnOrdinal!=a?(r=c[n.columnOrdinal],i[r]=n.value):(u=i.Pnl,t=n.value,s+=t-u,i.Pnl=t)});break;case"removed":if(!n.rowKey in o)return;r=v(n.rowKey);r>=0&&(i=t[r],s-=i.Pnl,delete o[n.rowKey],t.splice(r,1))}})},setIsLoading:function(){h=!0},state:{isLoading:function(){return h},data:function(){return t},totalPnl:function(){return s}}}}var r=$.hubConnection("signalR"),i,f,e=r.createHubProxy("data").on("OnFirmSummaryChanged",function(n){i&&!i.portfolioId&&u(function(){i.onChanges(n)})}).on("OnPortfolioChanged",function(n,t){i&&i.portfolioId==n&&u(function(){i.onChanges(t)})});return r.stateChanged(function(r){switch(r.newState){case $.signalR.connectionState.connecting:t.info("Attempting to connect.","Connecting to PoMo...");break;case $.signalR.connectionState.reconnecting:t.warning("Attempting to reconnect.","Connection to PoMo dropped...");break;case $.signalR.connectionState.connected:t.success(null,"Connection to PoMo established!");setTimeout(function(){f&&(f.unsubscribe(),f=null);i&&i.subscribe()},150);break;case $.signalR.connectionState.disconnected:i;t.error("Will attempt to reconnect in a minute.","Connection to PoMo lost...");setTimeout(o,6e4)}u(function(){n.$broadcast("stateChanged",r.newState)})}),o(),n.$on("$locationChangeStart",function(){i&&(i.unsubscribe(),i=null)}),{state:function(){return r.state},firmSummaryView:function(){return s(null),r.state===$.signalR.connectionState.connected&&i.subscribe(),i.state},portfolioView:function(n){return s(n),r.state===$.signalR.connectionState.connected&&i.subscribe(),i.state}}}]);